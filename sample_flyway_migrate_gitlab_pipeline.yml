flyway-migrate-prod:

  stage: prod
  
  image: docker:latest

  rules:
   - if: $CI_COMMIT_BRANCH == 'master'
     changes:
      - "xx/xxxxx/xxxxxxx/*"

  services:
   - docker:dind
   
  tags:
   - flyway

  variables:
   FLYWAY_URL: jdbc:sqlserver://${DB_SERVER};databaseName=${DB_NAME};encrypt=false
   FLYWAY_DIR: ${CI_PROJECT_DIR}/xx/xxxxx/xxxxxxx/
   FLYWAY_USER: flyway_user
   FLYWAY_PASSWORD: ${FLYWAY_PASSWORD_PROD}
 
  before_script:
   - cd ${FLYWAY_DIR}
 
  script:
   - docker run --rm -v ${FLYWAY_DIR}/migrations:/flyway/sql -v ${FLYWAY_DIR}/docker-conf:/flyway/conf flyway/flyway -url=${FLYWAY_URL} -user=${FLYWAY_USER} -password=${FLYWAY_PASSWORD} migrate info
