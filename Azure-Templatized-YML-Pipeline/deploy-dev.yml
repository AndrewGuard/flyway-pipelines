# NOTE: This pipeline depends on the following variable groups: 

# Name of variable group          Keys inside variable group
# ----------------------          --------------------------
# redgate_global_vars             FLYWAY_LICENSE_KEY, AGENT_POOL
# redgate_pipeline_vars           BASELINE_VERSION, FIRST_UNDO_SCRIPT
# redgate_build_credentials       userName, password, target_database_JDBC, databaseName
# redgate_test_credentials        userName, password, target_database_JDBC, databaseName, check_JDBC, check_userName, check_password

# Every target database will need its own variable group, which is referenced in a YML deployment script

name: ADO-self-hosted-pipeline-templatized
 
trigger:
  branches:
    include:
      - development
  paths:
    include:
      - migrations/*

variables:
- template: templates/vars.yml

stages:
- template: templates/build.yml
  parameters:
    stage: Build
    displayName: Deploy Build
    executeBuild: true
    targetCredentials: redgate_build_credentials
    pipelineParameters: redgate_pipeline_vars

- template: templates/deploy.yml
  parameters:
    stage: Test
    displayName: Deploy Test
    dependsOn: Build
    pauseForCodeReview: false
    failReleaseIfDriftDetected: false
    generateDriftAndChangeReport: true                   
    staticCodeAnalysis: false                             
    targetCredentials: redgate_test_credentials
    pipelineParameters: redgate_pipeline_vars
